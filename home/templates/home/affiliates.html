{% load wagtailcore_tags %}
{% wagtail_site as current_site %}
<div id="popUp" class="select-none mx-auto left-0 right-0 max-w-screen-lg fixed transition-all duration-700 translate-x-[200%] transform-gpu z-40 bottom-0">
  <div id="ramdomAff" class="transition-height duration-700 h-32 relative flex flex-col overflow-hidden bg-white lg:flex-row">
    <a id="url" href="#" aria-label="" target="_blank" class="flex flex-row justify-center items-center bg-white w-full">
     <div class="hidden relative lg:w-1/4 lg:flex justify-center">
      <img id="img" src="" alt="" class="object-contain max-h-36 px-4" />
    </div>
    <div class="w-full lg:w-3/4 px-4">
      <h5 id="title" class="w-full capitalize py-1 text-2xl font-extrabold leading-none sm:text-3xl"></h5>
      <p id="desc" class="mb-2 text-gray-800 w-full"></p>
    </div>
    </a>
  </div>
  <div id="offers" class="mb-[-4px] max-h-0 overflow-y-scroll w-full lg:mx-auto bg-gray-200 transform-gpu transition-windowmax-height duration-700 flex flex-col gap-2"></div>
  <div id="miniOffers" class="text-sm px-4 leading-none border font-semibold rounded text-cyan-700 bg-white overflow-hidden transition-height h-0 duration-700 relative flex flex-col shadow-sm lg:flex-row sm:mx-auto">
    <div id="titleScrollBtn" class="whitespace-nowrap text-center w-full h-max hover:cursor-pointer">
      <h5 class="uppercase text-lg font-semibold leading-none h-[32px] flex justify-center items-center">
        <i class="fa-solid fa-rectangle-ad px-4 text-blue-gray-800"></i><span id="typed"></span><i class="text-blue-gray-800 px-4 fa-solid fa-arrows-up-down"></i>
      </h5>
    </div>
  </div>
</div>

<style>
#ramdomAff, #miniOffers {
  filter: drop-shadow(0 -1px 1px rgb(0 0 0 / 0.1)) drop-shadow(0 -1px 1px rgb(0 0 0 / 0.06));
}
#offers {
  max-height: calc(100vh - 32px);
}
.max-h-0 {
  max-height: 0 !important;
}
</style>
<script>
function showOffers() {
  let ramdomAff = document.querySelector("#ramdomAff")
  let pop = document.querySelector("#popUp")  
  pop.classList.replace("max-w-screen-lg", "max-w-[300px]")
  ramdomAff.classList.replace("h-32","h-0")
  let openOffers = document.querySelector("#miniOffers")
  setTimeout(function() {
    openOffers.classList.replace("h-0","h-8")
  }, 200)
}

async function getAffiliates() {
  let rootSite = window.location.origin
  if (rootSite.includes("staging")) {
    rootSite = "https://staging.manjaro.org"
  } else if (!rootSite.includes("localhost")) {
    rootSite = rootSite.replace(/[/]\w*[.]/g, '/')
  }
  try {
    let response = await fetch(rootSite + "/ads.json");
  let ads = await response.json();
  let randomIndex = Math.floor(Math.random() * ads.length);
  let item = ads[randomIndex];
  let url = document.querySelector("#url")
  let desc = document.querySelector("#desc")
  let title = document.querySelector("#title")
  let img = document.querySelector("#img")
  url.href = item.url
  desc.textContent = item.desc
  title.textContent = item.title
  img.src = rootSite + "/media/" + item.img
  let pop = document.querySelector("#popUp")
  pop.classList.remove("translate-x-[200%]")
  for (a of ads) {
    titles.push(a.title)
    let offers = document.querySelector("#offers")
    let offersTemplate = `
    <div class="transition-height duration-700 relative flex flex-col flex-row">
    <a href="${a.url}" aria-label="${a.title}" target="_blank" class="flex flex-row bg-white px-2 lg:px-1 w-full">
     <div class="hidden relative lg:w-1/4 lg:flex justify-center">
      <img src="${rootSite + '/media/' + a.img}" alt="${a.title}" class="object-contain max-h-36 px-4" />
    </div>
    <div class="w-full lg:w-3/4 pr-4">
      <h5 class="capitalize py-1 text-2xl font-extrabold leading-none sm:text-3xl">${a.title}</h5>
      <p class="mb-2 text-gray-800">${a.desc}</p>
    </div>
    </a>
  </div>
    `
    offers.insertAdjacentHTML("beforeend", offersTemplate)
  }
  var typed = new Typed('#typed', {
  strings: titles,
  typeSpeed: 30,
  shuffle: false,
  loop: true,
  loopCount: Infinity,
  backDelay: 4500,
  showCursor: false,
  })

  let showOffersTransition = setTimeout(showOffers, 6000)
  } catch (error) {
    console.log(error)
  }
  
}

const titleScrollBtn = document.querySelector("#titleScrollBtn")

function closeSlider(event) {
  let el = document.querySelector("#offers")
  let target = event.target
  if ( !target.id.includes("offer") ) {
    let pop = document.querySelector("#popUp")  
    pop.classList.replace("max-w-screen-lg", "max-w-[300px]")
    el.classList.add("max-h-0")
    document.removeEventListener("click", closeSlider)
  } 
}
  
function toggleOffers() {
  let el = document.querySelector("#offers")
  let pop = document.querySelector("#popUp")  
  if (el.offsetHeight === 0) {
    pop.classList.replace("max-w-[300px]", "max-w-screen-lg")
    el.classList.remove("max-h-0")
    setTimeout(function() {
      document.addEventListener('click', closeSlider)
    }, 500)
  } else {
    pop.classList.replace("max-w-screen-lg", "max-w-[300px]")
    el.classList.add("max-h-0")
  }
}

function initAff() {
  let typed = document.createElement('script')
  typed.type = 'text/javascript'
  typed.src = 'https://unpkg.com/typed.js@2.0.16/dist/typed.umd.js'
  document.head.appendChild(typed)       
  titleScrollBtn.onclick = toggleOffers
  titleScrollBtn.ontouchend = toggleOffers
  const affiliatesTimeout = setTimeout(getAffiliates, 3000)
}
const titles = []
if (window.location.pathname.includes("download")) {
  
  modal = document.querySelector("#modal-edition")

  function isReady() {
    if (modal.classList.contains("hidden")) {
      clearInterval(checkAff)
      initAff()
    }
  }

  var checkAff = setInterval(isReady, 100)

} else if (!window.location.pathname.includes("donate")) {
  initAff()
} 
</script>